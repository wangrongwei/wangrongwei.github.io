<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>一个由dynamic_cast导致的问题</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><h2><a id="0x00_dynamic_cast_0"></a>0x00 dynamic_cast&lt;&gt;简介</h2>
<p>将指向基类的指针或者引用转换成指向这个基类派生类的指针或者引用，转换成功将会得到派生类的指针或者引用，如果失败，将会返回一个null。用法如下：</p>
<pre><code>dynamic_cast&lt;type *&gt;(msg)
dynamic_cast&lt;type &amp;&gt;(msg)
</code></pre>
<h2><a id="0x01__8"></a>0x01 问题描述</h2>
<blockquote>
<p>一个类成员函数中使用if-else进行dynamic_cast判断，type类在一个动态库dll中，导致程序链接阶段type1和type2未定义使用。有一个情况在在类其他成员函数中也使用了类type1和type2，将使用dynamic_cast处的程序屏蔽，可以链接通过，因此可以说明就是此处dynamic_cast的问题。</p>
</blockquote>
<p>原代码段如下：</p>
<pre><code>#if 0
    //原来的
    if (dynamic_cast&lt;IPv4ControlInfo *&gt;(msg-&gt;getControlInfo()) != NULL){
        IPv4ControlInfo *ctrl = (IPv4ControlInfo *)msg-&gt;getControlInfo();
        src = ctrl-&gt;getSrcAddr();
        dest = ctrl-&gt;getDestAddr();
        msgHopCount = ctrl-&gt;getTimeToLive();
    }
    else if (dynamic_cast&lt;IPv6ControlInfo *&gt;(msg-&gt;getControlInfo()) != NULL){
        IPv6ControlInfo *ctrl = (IPv6ControlInfo *)msg-&gt;getControlInfo();
        src = ctrl-&gt;getSrcAddr();
        dest = ctrl-&gt;getDestAddr();
        msgHopCount = ctrl-&gt;getHopLimit();
    }
#endif
</code></pre>
<p>链接过程出现的问题如下：</p>
<pre><code>apps/PingAppRandom.o:(.rdata[_ZTIN4inet15IPv4ControlInfoE]+0x28)：对‘typeinfo for inet::INetworkProtocolControlInfo’未定义的引用
apps/PingAppRandom.o:(.rdata[_ZTIN4inet15IPv6ControlInfoE]+0x28)：对‘typeinfo for inet::INetworkProtocolControlInfo’未定义的引用
</code></pre>
<p>为了证明问题定位没有毛病，我将上面的代码段改成if(1)，如下：</p>
<pre><code>#if 0
    //修改过
    if (1){
        IPv4ControlInfo *ctrl = (IPv4ControlInfo *)msg-&gt;getControlInfo();
        src = ctrl-&gt;getSrcAddr();
        dest = ctrl-&gt;getDestAddr();
        msgHopCount = ctrl-&gt;getTimeToLive();
    }
    else if (dynamic_cast&lt;IPv6ControlInfo *&gt;(msg-&gt;getControlInfo()) != NULL){
        IPv6ControlInfo *ctrl = (IPv6ControlInfo *)msg-&gt;getControlInfo();
        src = ctrl-&gt;getSrcAddr();
        dest = ctrl-&gt;getDestAddr();
        msgHopCount = ctrl-&gt;getHopLimit();
    }
#endif
</code></pre>
<p>使用上面的代码段，链接过程不会出现未定义的问题，因此可以说明是dynamic_cast&lt;&gt;使用不当或者其他编译设置问题。</p>
<h2><a id="0x02__59"></a>0x02 解决办法</h2>
</div>
</body>

</html>
